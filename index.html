<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino 積木編輯器 V6.5 (Event & Init)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; background-color: #1e1e1e; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        :root {
            --workspace-bg: #1e1e1e;
            --notch-size: 15px;
            --notch-height: 4px;
            --notch-left: 12px;
        }

        .block-base {
            position: relative;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2); 
            border: 1px solid rgba(0,0,0,0.1);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }

        .has-notch-top { margin-top: 2px; }
        .has-notch-top::before {
            content: ''; position: absolute; top: -1px; left: var(--notch-left);
            width: var(--notch-size); height: var(--notch-height);
            background-color: var(--workspace-bg);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            border-left: 1px solid rgba(0,0,0,0.1);
            border-right: 1px solid rgba(0,0,0,0.1);
            border-radius: 0 0 4px 4px; z-index: 2;
        }

        .has-bump-bottom { margin-bottom: 4px; }
        .has-bump-bottom::after {
            content: ''; position: absolute; bottom: -4px; left: var(--notch-left);
            width: var(--notch-size); height: var(--notch-height);
            background-color: inherit;
            border: 1px solid rgba(0,0,0,0.1); border-top: none;
            border-radius: 0 0 4px 4px; z-index: 1;
        }

        .block-hat { border-radius: 20px 20px 4px 4px; margin-top: 10px; }
        .block-cap { border-bottom: 2px solid rgba(0,0,0,0.2); margin-bottom: 4px; } 
        
        .c-interior {
            background-color: rgba(0,0,0,0.1); border-top: 1px solid rgba(0,0,0,0.1);
            min-height: 40px; padding-left: 10px; border-radius: 0 4px 4px 0;
            box-shadow: inset 0 2px 2px rgba(0,0,0,0.1);
            position: relative;
        }
        .c-interior::before {
            content: ''; position: absolute; top: 0; left: var(--notch-left);
            width: var(--notch-size); height: var(--notch-height);
            background-color: rgba(0,0,0,0.1);
            border-radius: 0 0 4px 4px;
        }

        .block-reporter { border-radius: 12px; padding: 4px 8px; display: inline-flex; align-items: center; margin: 0 4px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1); }
        .block-boolean { clip-path: polygon(10px 0, 100% 0, calc(100% - 10px) 50%, 100% 100%, 10px 100%, 0 50%); padding: 4px 12px; display: inline-flex; align-items: center; margin: 0 4px; }

        .bg-orange-500 { background-color: #ff8c1a; }
        .bg-yellow-500 { background-color: #ffbf00; color: #333; }
        .bg-blue-500 { background-color: #4c97ff; }
        .bg-purple-500 { background-color: #9966ff; }
        .bg-green-500 { background-color: #59c059; }
        .bg-red-500 { background-color: #ff6680; }
        .bg-gray-500 { background-color: #6b7280; }
        .bg-adv-input { background-color: #8b5cf6; } 
        .bg-adv-output { background-color: #0ea5e9; } 
        .bg-adv-code { background-color: #374151; border: 1px solid #4b5563; }

        .selected-block { box-shadow: 0 0 0 3px #fbbf24 !important; z-index: 50; }
        .dragging { opacity: 0.6; transform: scale(1.02); z-index: 100; pointer-events: none; }
        
        .drop-target { background-color: rgba(255, 255, 255, 0.1); outline: 2px dashed rgba(255, 255, 255, 0.5); border-radius: 4px; }
        .drop-target-invalid { cursor: not-allowed; }
        .drop-target-after { border-bottom: 4px solid #fbbf24 !important; margin-bottom: 4px; }
        
        .grid-bg {
            background-color: var(--workspace-bg);
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        details > summary { list-style: none; cursor: pointer; transition: background 0.2s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary .arrow { transform: rotate(90deg); }
        .accordion-content { border-left: 1px solid #4b5563; margin-left: 8px; padding-left: 8px; }

        #context-menu {
            position: absolute; display: none; z-index: 1000;
            background: #374151; border: 1px solid #4b5563; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .ctx-item { padding: 8px 16px; cursor: pointer; color: #e5e7eb; font-size: 13px; }
        .ctx-item:hover { background: #4b5563; }
        .ctx-divider { height: 1px; background: #4b5563; margin: 4px 0; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex overflow-hidden" onclick="globalClick()" oncontextmenu="return false;">

    <!-- 左側工具箱 -->
    <div class="w-80 flex flex-col border-r border-gray-700 bg-gray-800 z-10 shadow-xl" id="toolbox">
        <div class="p-4 bg-gray-900 font-bold flex items-center shadow text-yellow-400 border-b border-gray-700">
            <i data-lucide="cpu" class="mr-2"></i> 積木工具箱
        </div>
        <div class="flex flex-wrap gap-1 p-2 bg-gray-800 border-b border-gray-700" id="category-tabs"></div>
        
        <div class="flex bg-gray-700 text-xs font-bold border-b border-gray-600">
            <button onclick="switchMode('blocks')" class="flex-1 py-2 hover:bg-gray-600 border-r border-gray-600 bg-gray-600 text-white" id="tab-blocks">積木庫</button>
            <button onclick="switchMode('code-in')" class="flex-1 py-2 hover:bg-gray-600 text-gray-400" id="tab-code-in">代碼轉積木</button>
        </div>

        <div class="flex-1 overflow-y-auto p-3 space-y-6 custom-scrollbar relative" id="palette"></div>

        <div class="flex-1 flex flex-col p-3 hidden bg-gray-800" id="code-import-panel">
            <div class="text-xs text-gray-400 mb-2">C++ 代碼:</div>
            <textarea id="code-input" class="flex-1 bg-gray-900 border border-gray-600 rounded p-2 text-xs font-mono text-green-300 resize-none outline-none focus:border-blue-500" placeholder="void setup() { ... }"></textarea>
            <div id="import-error" class="hidden mt-2 p-2 bg-red-900/50 border border-red-500 rounded text-red-200 text-xs break-all"></div>
            <button onclick="parseAndImportCode()" class="mt-2 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold text-xs shadow">轉換為積木</button>
        </div>
        <div class="p-4 bg-red-900/20 border-t border-red-900/50 text-center text-red-400 text-xs transition-colors" id="trash-zone">
            <i data-lucide="trash-2" class="mx-auto mb-1"></i> 拖曳至此刪除
        </div>
    </div>

    <!-- 中間工作區 -->
    <div class="flex-1 flex flex-col bg-[#1e1e1e] relative overflow-hidden">
        <div class="h-12 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 shadow-md z-20">
            <div class="flex items-center text-gray-400 text-sm">
                <i data-lucide="mouse-pointer-2" class="mr-2 w-4"></i> 自動初始化與防呆
            </div>
            <div class="flex space-x-2">
                <button onclick="deleteSelected()" class="flex items-center text-red-400 hover:bg-red-900/50 px-3 py-1 rounded transition-colors text-sm">
                    <i data-lucide="trash" class="w-4 h-4 mr-1"></i> 刪除
                </button>
                <button onclick="resetWorkspace()" class="flex items-center text-gray-300 hover:bg-gray-700 px-3 py-1 rounded transition-colors text-sm">
                    <i data-lucide="rotate-ccw" class="mr-1 w-4"></i> 重置
                </button>
            </div>
        </div>
        <div id="workspace" class="flex-1 overflow-auto p-8 relative grid-bg"></div>
    </div>

    <!-- 右側預覽 -->
    <div class="w-96 bg-gray-950 border-l border-gray-800 flex flex-col z-10 shadow-xl">
        <div class="h-12 bg-gray-900 border-b border-gray-800 flex items-center px-4 font-mono text-sm text-green-400">
            <i data-lucide="terminal" class="mr-2 w-4"></i> C++ Code
        </div>
        <div class="flex-1 overflow-auto p-4 font-mono text-xs text-green-300/90 whitespace-pre-wrap select-text custom-scrollbar bg-[#111]" id="code-preview"></div>
        <div class="p-4 border-t border-gray-800 bg-gray-900">
            <button onclick="copyCode()" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold text-sm transition-colors shadow-lg flex items-center justify-center">
                <i data-lucide="copy" class="mr-2 w-4"></i> 複製程式碼
            </button>
        </div>
    </div>

    <div id="context-menu">
        <div class="ctx-item" onclick="duplicateSelected()">複製 (Ctrl+C)</div>
        <div class="ctx-divider"></div>
        <div class="ctx-item text-red-400" onclick="deleteSelected()">刪除 (Del)</div>
    </div>
    <div id="modal-overlay" class="fixed inset-0 bg-black/70 hidden flex items-center justify-center z-50 backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl border border-gray-600 w-80 transform transition-all">
            <h3 id="modal-title" class="text-white mb-4 font-bold text-lg">新建</h3>
            <input type="text" id="modal-input" class="w-full bg-gray-900 text-white p-2 rounded border border-gray-700 mb-6 focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-400 hover:bg-gray-700 rounded transition-colors text-sm">取消</button>
                <button id="modal-confirm" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded shadow text-sm">確定</button>
            </div>
        </div>
    </div>

<script>
    const SHAPES = { HAT: 'HAT', STACK: 'STACK', C_BLOCK: 'C', CAP: 'CAP', REPORTER: 'VAL', BOOLEAN: 'BOOL' };
    
    const ADVANCED_HIERARCHY = {
        CUSTOM: {
             name: '自訂代碼',
             color: 'bg-adv-code',
             components: [
                 { name: '純文字代碼', blocks: ['RAW_CODE'] }
             ]
        },
        INPUT: {
            name: '輸入模組',
            color: 'bg-adv-input',
            components: [
                { name: '超音波 (Ultrasonic)', blocks: ['ADV_ULTRASONIC_READ'] },
                { name: '紅外線 (IR)', blocks: ['ADV_IR_READ'] },
                { name: '4x4 鍵盤 (Keypad)', blocks: ['ADV_KEYPAD_READ'] },
                { name: '按鈕 (Button)', blocks: ['ADV_BUTTON_PRESSED'] },
                { name: '電位器 (Potentiometer)', blocks: ['ADV_POT_READ'] },
                { name: '光敏電阻 (Photoresistor)', blocks: ['ADV_PHOTO_READ'] }
            ]
        },
        OUTPUT: {
            name: '輸出模組',
            color: 'bg-adv-output',
            components: [
                { name: 'LED / 燈光', blocks: ['LED_SET', 'ADV_LED_BLINK', 'ADV_RGB_SET'] },
                { name: '繼電器 (Relay)', blocks: ['ADV_RELAY_SET'] },
                { name: 'LCD 1602 (I2C)', blocks: ['ADV_LCD_PRINT', 'ADV_LCD_CLEAR'] },
                { name: '七段顯示器 (TM1637)', blocks: ['ADV_TM1637_SHOW'] },
                { name: '馬達控制', blocks: ['ADV_MOTOR_RUN', 'ADV_SERVO_WRITE'] }
            ]
        }
    };

    const BLOCK_DEFS = {
        // [事件 & 初始化] - 移至此分類
        SETUP: { type: 'SETUP', cat: 'EVENT', name: '當 Arduino 開啟', shape: SHAPES.HAT },
        PIN_MODE: { type: 'PIN_MODE', cat: 'EVENT', name: '設定腳位 ( pin ) 為 * mode *', args: [{type: 'NUM', default: 13}, {type: 'MENU', options: ['OUTPUT', 'INPUT']}], shape: SHAPES.STACK },
        SERIAL_BEGIN: { type: 'SERIAL_BEGIN', cat: 'EVENT', name: '設定序列埠鮑率 ( rate )', args: [{type: 'NUM', default: 9600}], shape: SHAPES.STACK },
        ADV_LCD_INIT: { type: 'ADV_LCD_INIT', cat: 'EVENT', name: '初始化 LCD 1602 (I2C)', shape: SHAPES.STACK, color: 'bg-adv-output' },
        ADV_SERVO_ATTACH: { type: 'ADV_SERVO_ATTACH', cat: 'EVENT', name: '伺服馬達連接腳位 ( pin )', args: [{type: 'NUM', default: 9}], shape: SHAPES.STACK, color: 'bg-adv-output' },
        ADV_TM1637_INIT: { type: 'ADV_TM1637_INIT', cat: 'EVENT', name: '初始化七段顯示器 CLK:( c ) DIO:( d )', args: [{type: 'NUM', default: 2}, {type: 'NUM', default: 3}], shape: SHAPES.STACK, color: 'bg-adv-output' },
        ADV_IR_INIT: { type: 'ADV_IR_INIT', cat: 'EVENT', name: '紅外線接收啟用 (Pin: ( p ))', args: [{type: 'NUM', default: 11}], shape: SHAPES.STACK, color: 'bg-adv-input' },

        // [控制]
        WAIT: { type: 'WAIT', cat: 'CONTROL', name: '等待 ( time ) 毫秒', args: [{type: 'NUM', default: 1000}], shape: SHAPES.STACK },
        WAIT_UNTIL: { type: 'WAIT_UNTIL', cat: 'CONTROL', name: '等待直到 < cond >', args: [{type: 'BOOL', default: false}], shape: SHAPES.STACK },
        FOREVER: { type: 'FOREVER', cat: 'LOOP', name: '重複無限次', shape: SHAPES.CAP, isLoop: true },
        REPEAT: { type: 'REPEAT', cat: 'LOOP', name: '重複 ( times ) 次', args: [{type: 'NUM', default: 10}], shape: SHAPES.C_BLOCK },
        REPEAT_UNTIL: { type: 'REPEAT_UNTIL', cat: 'LOOP', name: '重複直到 < cond >', args: [{type: 'BOOL', default: false}], shape: SHAPES.C_BLOCK },
        IF: { type: 'IF', cat: 'LOGIC', name: '如果 < cond > 那麼', args: [{type: 'BOOL', default: false}], shape: SHAPES.C_BLOCK },
        IF_ELSE: { type: 'IF_ELSE', cat: 'LOGIC', name: '如果 < cond > 那麼...否則', args: [{type: 'BOOL', default: false}], shape: SHAPES.C_BLOCK, hasElse: true },
        COMPARE: { type: 'COMPARE', cat: 'LOGIC', name: '( a ) * op * ( b )', args: [{type: 'NUM', default: 0}, {type: 'MENU', options: ['==','!=','>','<','>=','<=']}, {type: 'NUM', default: 0}], shape: SHAPES.BOOLEAN },
        
        // [數學]
        NUMBER: { type: 'NUMBER', cat: 'MATH', name: '( val )', args: [{type: 'NUM', default: 0}], shape: SHAPES.REPORTER },
        MATH_OP: { type: 'MATH_OP', cat: 'MATH', name: '( a ) * op * ( b )', args: [{type: 'NUM', default: 0}, {type: 'MENU', options: ['+','-','*','/']}, {type: 'NUM', default: 0}], shape: SHAPES.REPORTER },
        RANDOM: { type: 'RANDOM', cat: 'MATH', name: '隨機取數 ( min ) 到 ( max )', args: [{type: 'NUM', default: 1}, {type: 'NUM', default: 10}], shape: SHAPES.REPORTER },
        
        // [變數/清單]
        VAR_GET: { type: 'VAR_GET', cat: 'VAR', name: 'varName', isVar: true, shape: SHAPES.REPORTER },
        VAR_SET: { type: 'VAR_SET', cat: 'VAR', name: '變數 * var * 設為 ( val )', args: [{type: 'VAR_MENU'}, {type: 'NUM', default: 0}], shape: SHAPES.STACK },
        VAR_CHANGE: { type: 'VAR_CHANGE', cat: 'VAR', name: '變數 * var * 改變 ( val )', args: [{type: 'VAR_MENU'}, {type: 'NUM', default: 1}], shape: SHAPES.STACK },
        LIST_ADD: { type: 'LIST_ADD', cat: 'LIST', name: '添加 ( val ) 到 * list *', args: [{type: 'NUM', default: 0}, {type: 'LIST_MENU'}], shape: SHAPES.STACK },
        LIST_DEL_ALL: { type: 'LIST_DEL_ALL', cat: 'LIST', name: '刪除 * list * 的所有項目', args: [{type: 'LIST_MENU'}], shape: SHAPES.STACK },
        LIST_ITEM: { type: 'LIST_ITEM', cat: 'LIST', name: '* list * 的第 ( idx ) 項', args: [{type: 'LIST_MENU'}, {type: 'NUM', default: 0}], shape: SHAPES.REPORTER },
        
        // [IO]
        LED_SET: { type: 'LED_SET', cat: 'IO', name: '數位寫入 Pin ( pin ) 為 * status *', args: [{type: 'NUM', default: 13}, {type: 'MENU', options: ['HIGH', 'LOW']}], shape: SHAPES.STACK },
        DIGITAL_READ: { type: 'DIGITAL_READ', cat: 'IO', name: '讀取數位腳位 ( pin )', args: [{type: 'NUM', default: 2}], shape: SHAPES.REPORTER },
        ANALOG_WRITE: { type: 'ANALOG_WRITE', cat: 'IO', name: '類比寫入 Pin ( pin ) 為 ( val )', args: [{type: 'NUM', default: 3}, {type: 'NUM', default: 255}], shape: SHAPES.STACK },
        SERIAL_PRINT: { type: 'SERIAL_PRINT', cat: 'IO', name: '列印至串列監視器 ( val )', args: [{type: 'ANY', default: 'Hello'}], shape: SHAPES.STACK },

        // [進階]
        RAW_CODE: { type: 'RAW_CODE', cat: 'ADVANCED', name: '代碼', args: [{type: 'TEXTAREA', default: '// 寫入代碼...'}], shape: SHAPES.STACK, color: 'bg-gray-500' },
        ADV_ULTRASONIC_READ: { type: 'ADV_ULTRASONIC_READ', cat: 'ADVANCED', name: '讀取超音波距離 (cm) Trig:( t ) Echo:( e )', args: [{type: 'NUM', default: 9}, {type: 'NUM', default: 10}], shape: SHAPES.REPORTER, color: 'bg-adv-input' },
        ADV_IR_READ: { type: 'ADV_IR_READ', cat: 'ADVANCED', name: '紅外線接收值 (Pin: ( p ))', args: [{type: 'NUM', default: 11}], shape: SHAPES.REPORTER, color: 'bg-adv-input' },
        ADV_KEYPAD_READ: { type: 'ADV_KEYPAD_READ', cat: 'ADVANCED', name: '讀取 4x4 鍵盤按鍵', shape: SHAPES.REPORTER, color: 'bg-adv-input' },
        ADV_BUTTON_PRESSED: { type: 'ADV_BUTTON_PRESSED', cat: 'ADVANCED', name: '按鈕 (Pin: ( p )) 被按下?', args: [{type: 'NUM', default: 2}], shape: SHAPES.BOOLEAN, color: 'bg-adv-input' },
        ADV_POT_READ: { type: 'ADV_POT_READ', cat: 'ADVANCED', name: '讀取電位器 (Pin: ( p ))', args: [{type: 'NUM', default: 'A0'}], shape: SHAPES.REPORTER, color: 'bg-adv-input' },
        ADV_PHOTO_READ: { type: 'ADV_PHOTO_READ', cat: 'ADVANCED', name: '讀取光敏電阻 (Pin: ( p ))', args: [{type: 'NUM', default: 'A1'}], shape: SHAPES.REPORTER, color: 'bg-adv-input' },
        ADV_LED_BLINK: { type: 'ADV_LED_BLINK', cat: 'ADVANCED', name: 'LED 閃爍 (Pin:( p ) 間隔:( ms )ms)', args: [{type: 'NUM', default: 13}, {type: 'NUM', default: 500}], shape: SHAPES.STACK, color: 'bg-adv-output' },
        ADV_RGB_SET: { type: 'ADV_RGB_SET', cat: 'ADVANCED', name: '設定 RGB (R:( r ) G:( g ) B:( b ))', args: [{type: 'NUM', default: 255}, {type: 'NUM', default: 0}, {type: 'NUM', default: 0}], shape: SHAPES.STACK, color: 'bg-adv-output' },
        ADV_RELAY_SET: { type: 'ADV_RELAY_SET', cat: 'ADVANCED', name: '繼電器/燈泡 (Pin: ( p )) * stat *', args: [{type: 'NUM', default: 3}, {type: 'MENU', options: ['開', '關']}], shape: SHAPES.STACK, color: 'bg-adv-output' },
        ADV_LCD_PRINT: { type: 'ADV_LCD_PRINT', cat: 'ADVANCED', name: 'LCD 顯示文字 ( txt )', args: [{type: 'ANY', default: 'Hello'}], shape: SHAPES.STACK, color: 'bg-adv-output' },
        ADV_LCD_CLEAR: { type: 'ADV_LCD_CLEAR', cat: 'ADVANCED', name: 'LCD 清除畫面', shape: SHAPES.STACK, color: 'bg-adv-output' },
        ADV_TM1637_SHOW: { type: 'ADV_TM1637_SHOW', cat: 'ADVANCED', name: '七段顯示器 顯示 ( num )', args: [{type: 'NUM', default: 1234}], shape: SHAPES.STACK, color: 'bg-adv-output' },
        ADV_MOTOR_RUN: { type: 'ADV_MOTOR_RUN', cat: 'ADVANCED', name: '直流馬達 (Pin: ( p )) 速度 ( spd )', args: [{type: 'NUM', default: 5}, {type: 'NUM', default: 255}], shape: SHAPES.STACK, color: 'bg-adv-output' },
        ADV_SERVO_WRITE: { type: 'ADV_SERVO_WRITE', cat: 'ADVANCED', name: '伺服馬達 (Pin: ( p )) 轉動到 ( deg ) 度', args: [{type: 'NUM', default: 9}, {type: 'NUM', default: 90}], shape: SHAPES.STACK, color: 'bg-adv-output' },
    };

    const CATEGORIES = {
        EVENT: { name: '事件 & 初始化', color: 'bg-yellow-500', icon: 'play-circle' },
        CONTROL: { name: '控制', color: 'bg-orange-500', icon: 'settings' },
        LOOP: { name: '迴圈', color: 'bg-green-500', icon: 'refresh-cw' },
        LOGIC: { name: '邏輯', color: 'bg-blue-500', icon: 'git-branch' },
        MATH: { name: '運算', color: 'bg-green-400', icon: 'plus' },
        VAR: { name: '變數', color: 'bg-orange-400', icon: 'type' },
        LIST: { name: '清單', color: 'bg-red-500', icon: 'list' },
        IO: { name: '硬體', color: 'bg-purple-500', icon: 'cpu' },
        ADVANCED: { name: '進階', color: 'bg-indigo-500', icon: 'zap' }
    };

    let state = { script: [], variables: [], lists: [] };
    let dragData = null; 
    let selectedBlockIds = new Set();

    function init() {
        document.addEventListener('contextmenu', event => event.preventDefault());
        setupEventListeners();
        resetWorkspace();
        renderSidebar();
        lucide.createIcons();
        document.addEventListener('keydown', handleKeyDown);
    }

    function globalClick() {
        hideContextMenu();
        clearSelectionDOM();
    }

    function selectBlockDOM(id) {
        selectedBlockIds.add(id);
        const el = document.getElementById('block-' + id);
        if (el) el.classList.add('selected-block');
    }

    function clearSelectionDOM() {
        selectedBlockIds.clear();
        document.querySelectorAll('.selected-block').forEach(el => el.classList.remove('selected-block'));
    }

    function toggleSelectionDOM(id) {
        if (selectedBlockIds.has(id)) {
            selectedBlockIds.delete(id);
            const el = document.getElementById('block-' + id);
            if(el) el.classList.remove('selected-block');
        } else {
            selectBlockDOM(id);
        }
    }

    function setupEventListeners() {
        const trash = document.getElementById('toolbox');
        const trashZone = document.getElementById('trash-zone');
        if (trash && trashZone) {
            trash.ondragover = (e) => { e.preventDefault(); trashZone.classList.add('bg-red-800'); };
            trash.ondragleave = () => { trashZone.classList.remove('bg-red-800'); };
            trash.ondrop = (e) => {
                e.preventDefault();
                trashZone.classList.remove('bg-red-800');
                if (dragData && dragData.type === 'MOVE') {
                    const block = findBlock(dragData.id);
                    if (block && !block.locked) {
                        findAndRemoveBlock(dragData.id);
                        renderWorkspace();
                        checkAndAddInitBlocks();
                        updateCode();
                    }
                }
            };
        }
        const ws = document.getElementById('workspace');
        if (ws) {
            ws.ondragover = (e) => { 
                e.preventDefault();
                if (dragData) {
                    const type = dragData.defKey || findBlockType(dragData.id);
                    if (!type || !BLOCK_DEFS[type]) return;
                    const def = BLOCK_DEFS[type];
                    let isValid = true;
                    if (def.shape === SHAPES.REPORTER || def.shape === SHAPES.BOOLEAN) isValid = false;
                    if (state.script.length > 0) {
                        const lastBlock = state.script[state.script.length - 1];
                        const lastDef = BLOCK_DEFS[lastBlock.type];
                        if (lastDef && lastDef.shape === SHAPES.CAP) {
                            if (def.shape !== SHAPES.HAT) isValid = false;
                        }
                    }
                    if (isValid) ws.classList.add('drop-target');
                    else ws.classList.remove('drop-target');
                }
            };
            ws.ondragleave = () => ws.classList.remove('drop-target');
            ws.ondrop = (e) => {
                e.preventDefault();
                ws.classList.remove('drop-target');
                if (dragData) {
                    const type = dragData.defKey || findBlockType(dragData.id);
                    if (!type || !BLOCK_DEFS[type]) return;
                    const def = BLOCK_DEFS[type];
                    let isValid = true;
                    if (def.shape === SHAPES.REPORTER || def.shape === SHAPES.BOOLEAN) isValid = false;
                    if (state.script.length > 0) {
                        const lastBlock = state.script[state.script.length - 1];
                        const lastDef = BLOCK_DEFS[lastBlock.type];
                        if (lastDef && lastDef.shape === SHAPES.CAP) {
                             if (def.shape !== SHAPES.HAT) isValid = false;
                        }
                    }
                    if (isValid) handleDrop(dragData, state.script, null, 'APPEND');
                }
            };
        }
    }

    function resetWorkspace() {
        state.script = [{ id: 'root-setup', type: 'SETUP', args: [], children: [], elseChildren: [], locked: true }];
        renderWorkspace();
        updateCode();
    }

    function uid() { return Math.random().toString(36).substr(2, 9); }

    function switchMode(mode) {
        if (mode === 'blocks') {
            document.getElementById('palette').classList.remove('hidden');
            document.getElementById('code-import-panel').classList.add('hidden');
            document.getElementById('tab-blocks').classList.add('text-white');
            document.getElementById('tab-code-in').classList.remove('text-white');
        } else {
            document.getElementById('palette').classList.add('hidden');
            document.getElementById('code-import-panel').classList.remove('hidden');
            document.getElementById('tab-blocks').classList.remove('text-white');
            document.getElementById('tab-code-in').classList.add('text-white');
        }
    }

    function renderSidebar() {
        const tabs = document.getElementById('category-tabs');
        const palette = document.getElementById('palette');
        tabs.innerHTML = ''; palette.innerHTML = '';

        Object.entries(CATEGORIES).forEach(([key, cat]) => {
            const btn = document.createElement('button');
            btn.className = `flex items-center px-2 py-1 text-xs rounded ${cat.color} text-white shadow hover:opacity-80`;
            btn.innerHTML = `<i data-lucide="${cat.icon}" class="w-3 h-3 mr-1"></i> ${cat.name}`;
            btn.onclick = () => document.getElementById(`cat-${key}`).scrollIntoView({behavior: 'smooth'});
            tabs.appendChild(btn);
        });

        Object.keys(CATEGORIES).forEach(catKey => {
            const section = document.createElement('div');
            section.id = `cat-${catKey}`;
            section.className = 'mb-6';
            section.innerHTML = `<h3 class="text-[10px] text-gray-500 mb-2 font-bold uppercase pl-1">${CATEGORIES[catKey].name}</h3>`;

            if (catKey === 'ADVANCED') {
                Object.entries(ADVANCED_HIERARCHY).forEach(([subKey, subGroup]) => {
                    const details = document.createElement('details');
                    details.className = 'mb-2 bg-gray-800 border border-gray-600 rounded';
                    if (subKey === 'INPUT' || subKey === 'OUTPUT') details.open = true;
                    
                    const summary = document.createElement('summary');
                    summary.className = `px-3 py-2 text-xs font-bold text-white bg-gray-700 rounded hover:bg-gray-600 flex items-center justify-between select-none`;
                    summary.innerHTML = `<span>${subGroup.name}</span> <i data-lucide="chevron-right" class="arrow w-3 h-3 transition-transform"></i>`;
                    details.appendChild(summary);
                    
                    const content = document.createElement('div');
                    content.className = 'accordion-content py-2';
                    
                    subGroup.components.forEach(comp => {
                         const compDetails = document.createElement('details');
                         compDetails.className = 'mb-1 ml-2';
                         const compSummary = document.createElement('summary');
                         compSummary.className = `px-2 py-1 text-xs text-gray-300 hover:text-white flex items-center`;
                         compSummary.innerHTML = `<i data-lucide="chevron-right" class="arrow w-3 h-3 mr-1 transition-transform"></i> ${comp.name}`;
                         compDetails.appendChild(compSummary);
                         
                         const compContent = document.createElement('div');
                         compContent.className = 'pl-4 mt-1';
                         comp.blocks.forEach(blockKey => {
                             compContent.appendChild(createSidebarBlock({ type: blockKey }, subGroup.color));
                         });
                         compDetails.appendChild(compContent);
                         content.appendChild(compDetails);
                    });
                    details.appendChild(content);
                    section.appendChild(details);
                });
            } else {
                if (catKey === 'VAR') {
                    section.appendChild(createBtn('+ 建立變數', () => openModal('VAR')));
                    state.variables.forEach(v => section.appendChild(createSidebarBlock({ type: 'VAR_GET', data: { varName: v, name: v } }, CATEGORIES.VAR.color)));
                }
                if (catKey === 'LIST') {
                    section.appendChild(createBtn('+ 建立清單', () => openModal('LIST')));
                    state.lists.forEach(l => {
                        const div = document.createElement('div');
                        div.className = `px-3 py-1 mb-1 rounded-full text-xs text-white shadow text-center bg-red-500 border border-white/20 select-none`;
                        div.innerText = l;
                        section.appendChild(div);
                    });
                }
                
                Object.keys(BLOCK_DEFS).filter(k => BLOCK_DEFS[k].cat === catKey).forEach(key => {
                    const def = BLOCK_DEFS[key];
                    if ((catKey === 'VAR' && def.isVar) || (catKey === 'LIST' && def.type === 'LIST_ITEM')) return;
                    if (catKey !== 'ADVANCED') section.appendChild(createSidebarBlock({ type: key }, CATEGORIES[catKey].color));
                });
            }
            palette.appendChild(section);
        });
        lucide.createIcons();
    }

    function createBtn(text, onClick) {
        const btn = document.createElement('button');
        btn.className = 'w-full py-1 bg-gray-700 text-xs rounded border border-gray-600 mb-2 text-gray-300 hover:bg-gray-600';
        btn.innerText = text;
        btn.onclick = onClick;
        return btn;
    }

    function createSidebarBlock(info, colorClass) {
        const def = BLOCK_DEFS[info.type];
        const displayName = (info.data && info.data.name) ? info.data.name : def.name;
        const el = document.createElement('div');
        let shape = 'rounded';
        if (def.shape === SHAPES.REPORTER) shape = 'rounded-full px-3';
        if (def.shape === SHAPES.BOOLEAN) shape = 'clip-hex px-3';
        
        el.className = `mb-2 px-3 py-2 text-xs text-white shadow-sm hover:shadow-md cursor-grab active:cursor-grabbing transition-transform hover:translate-x-1 ${colorClass} ${shape} truncate`;
        el.innerText = displayName;
        el.draggable = true;
        el.ondragstart = (e) => {
            e.stopPropagation();
            dragData = { type: 'NEW', defKey: info.type, data: info.data || {} };
            e.dataTransfer.effectAllowed = 'copy';
        };
        return el;
    }

    function renderWorkspace() {
        const ws = document.getElementById('workspace');
        ws.innerHTML = '';
        state.script.forEach(block => ws.appendChild(createBlockElement(block, state.script)));
        lucide.createIcons();
    }

    function createBlockElement(block, parentList) {
        const def = BLOCK_DEFS[block.type] || { ...block, shape: SHAPES.STACK, color: 'bg-gray-500' };
        const cat = CATEGORIES[def.cat] || { color: 'bg-gray-500' };
        const bgColor = def.color || cat.color;
        
        const el = document.createElement('div');
        el.id = 'block-' + block.id;
        let classes = `block-base text-white relative group select-none p-2 ${bgColor} `;
        
        if (def.shape === SHAPES.HAT) classes += 'block-hat has-bump-bottom ';
        else if (def.shape === SHAPES.CAP) classes += 'block-cap has-notch-top '; 
        else if (def.shape === SHAPES.STACK || def.shape === SHAPES.C_BLOCK) classes += 'block-stack has-notch-top has-bump-bottom ';
        else if (def.shape === SHAPES.REPORTER) classes = `text-white relative group select-none block-reporter shadow-md ${bgColor} `;
        else if (def.shape === SHAPES.BOOLEAN) classes = `text-white relative group select-none block-boolean shadow-md ${bgColor} `;

        if (selectedBlockIds.has(block.id)) classes += 'selected-block ';

        el.className = classes;
        
        if (block.locked) {
            el.draggable = false;
            el.style.cursor = 'default';
        } else {
            el.draggable = true;
            el.onmousedown = (e) => {
                e.stopPropagation();
                const isControl = ['INPUT', 'SELECT', 'OPTION', 'TEXTAREA'].includes(e.target.tagName);
                if (e.button === 2) { showContextMenu(e, block.id); return; }
                if (!isControl) {
                    if (e.ctrlKey || e.metaKey) toggleSelectionDOM(block.id);
                    else { clearSelectionDOM(); selectBlockDOM(block.id); }
                }
            };
            el.ondragstart = (e) => {
                if (['INPUT', 'SELECT', 'OPTION', 'TEXTAREA'].includes(e.target.tagName)) {
                    e.preventDefault(); return;
                }
                e.stopPropagation();
                dragData = { type: 'MOVE', id: block.id, parentList: parentList };
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => el.classList.add('dragging'), 0);
            };
            el.ondragend = () => { el.classList.remove('dragging'); dragData = null; };
        }

        if (def.shape === SHAPES.STACK || def.shape === SHAPES.C_BLOCK || def.shape === SHAPES.CAP) {
            el.ondragover = (e) => {
                e.preventDefault();
                if (dragData) {
                    const type = dragData.defKey || findBlockType(dragData.id);
                    if (!type || !BLOCK_DEFS[type]) return;
                    const dragDef = BLOCK_DEFS[type];
                    if (dragDef.shape === SHAPES.REPORTER || dragDef.shape === SHAPES.BOOLEAN) return;
                    if (dragDef.shape === SHAPES.HAT) return; 
                    if (dragData.id === block.id) return; 
                    if (def.shape === SHAPES.CAP) return;
                    e.stopPropagation(); 
                    el.classList.add('drop-target-after');
                }
            };
            el.ondragleave = () => el.classList.remove('drop-target-after');
            el.ondrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                el.classList.remove('drop-target-after');
                if (dragData) {
                    const idx = parentList.indexOf(block);
                    if (idx !== -1) handleDrop(dragData, parentList, idx + 1, 'INSERT');
                }
            };
        }

        const header = document.createElement('div');
        header.className = 'flex items-center flex-wrap gap-1 pointer-events-none';
        
        const parts = def.name.split(/(\( [a-z0-9]+ \)|< [a-z0-9]+ >|\* [a-z0-9]+ \*)/);
        let argIdx = 0;

        if (block.type === 'VAR_GET') header.innerText = block.varName;
        else if (block.type === 'RAW_CODE') {
             header.appendChild(createArgElement(block, 0, {type: 'TEXTAREA'}, el));
        }
        else {
            parts.forEach(part => {
                if (part.match(/\( [a-z0-9]+ \)|< [a-z0-9]+ >|\* [a-z0-9]+ \*/)) {
                    header.appendChild(createArgElement(block, argIdx, def.args[argIdx], el));
                    argIdx++;
                } else {
                    const span = document.createElement('span');
                    span.className = 'font-bold text-sm mx-0.5';
                    span.innerText = part.trim();
                    header.appendChild(span);
                }
            });
        }
        
        if (block.locked) {
            header.innerHTML += `<i data-lucide="lock" class="w-3 h-3 ml-2 opacity-50"></i>`;
        }
        
        el.appendChild(header);

        if (def.shape === SHAPES.C_BLOCK || def.isLoop) {
            const container = document.createElement('div');
            container.className = 'c-interior mt-1 transition-colors';
            setupDropZone(container, (dropped) => moveBlock(dropped, block.children), block.children);
            block.children.forEach(child => container.appendChild(createBlockElement(child, block.children)));
            el.appendChild(container);
        }

        if (def.hasElse) {
            const elseLabel = document.createElement('div');
            elseLabel.className = 'text-xs font-bold px-1 py-1 border-t border-white/10 pointer-events-none';
            elseLabel.innerText = '否則';
            el.appendChild(elseLabel);
            const elseContainer = document.createElement('div');
            elseContainer.className = 'c-interior transition-colors';
            setupDropZone(elseContainer, (dropped) => moveBlock(dropped, block.elseChildren), block.elseChildren);
            block.elseChildren.forEach(child => elseContainer.appendChild(createBlockElement(child, block.elseChildren)));
            el.appendChild(elseContainer);
        }

        return el;
    }

    function createArgElement(block, argIdx, argDef, blockEl) {
        const wrapper = document.createElement('div');
        wrapper.className = 'pointer-events-auto inline-block align-middle';
        const val = block.args[argIdx];

        if (typeof val === 'object' && val.id) {
            const argBlock = createBlockElement(val, block.args);
            argBlock.ondragstart = (e) => {
                e.stopPropagation();
                dragData = { type: 'MOVE', id: val.id, sourceArgs: block.args, sourceIdx: argIdx };
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => argBlock.classList.add('dragging'), 0);
            };
            argBlock.ondragend = () => { argBlock.classList.remove('dragging'); dragData = null; };
            wrapper.appendChild(argBlock);
            return wrapper;
        }

        const selectWithoutRender = () => {
            clearSelectionDOM();
            selectBlockDOM(block.id);
            hideContextMenu();
        };

        if (['MENU', 'VAR_MENU', 'LIST_MENU'].includes(argDef.type)) {
            const select = document.createElement('select');
            const bgClass = argDef.type === 'LIST_MENU' ? 'bg-red-100' : 'bg-white/90';
            select.className = `text-black text-xs px-1 py-0.5 rounded mx-1 border-none outline-none cursor-pointer ${bgClass}`;
            let options = argDef.options || [];
            if (argDef.type === 'VAR_MENU') options = state.variables.length ? state.variables : ['無變數'];
            if (argDef.type === 'LIST_MENU') options = state.lists.length ? state.lists : ['無清單'];

            options.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt;
                o.innerText = opt;
                if (opt === val) o.selected = true;
                select.appendChild(o);
            });
            
            select.onmousedown = (e) => { e.stopPropagation(); selectWithoutRender(); };
            select.onchange = (e) => { 
                block.args[argIdx] = e.target.value; 
                checkAndAddInitBlocks(); 
                updateCode(); 
            };
            wrapper.appendChild(select);
            return wrapper;
        }

        const slot = document.createElement('div');
        const shapeClass = argDef.type === 'BOOL' ? 'clip-hex px-3' : 'rounded-full px-2';
        slot.className = `inline-flex items-center justify-center min-w-[30px] h-[24px] mx-1 text-xs transition-all bg-black/20 hover:bg-black/30 ${shapeClass}`;
        
        slot.ondragover = (e) => { e.preventDefault(); slot.classList.add('bg-yellow-100/50'); };
        slot.ondragleave = () => slot.classList.remove('bg-yellow-100/50');
        slot.ondrop = (e) => {
            e.preventDefault();
            e.stopPropagation();
            slot.classList.remove('bg-yellow-100/50');
            if (dragData) {
                const def = BLOCK_DEFS[dragData.defKey || findBlockType(dragData.id)];
                if (!def) return;

                const compatible = (argDef.type === 'NUM' && def.shape === SHAPES.REPORTER) ||
                                   (argDef.type === 'BOOL' && def.shape === SHAPES.BOOLEAN) ||
                                   (argDef.type === 'ANY' && def.shape === SHAPES.REPORTER);
                if (compatible) handleDrop(dragData, block.args, argIdx, 'REPLACE');
            }
        };

        if (argDef.type === 'NUM' || argDef.type === 'ANY' || argDef.type === 'TEXTAREA') {
            const input = document.createElement(argDef.type === 'TEXTAREA' ? 'textarea' : 'input');
            if(argDef.type === 'TEXTAREA') {
                input.value = val;
                input.className = 'bg-black/30 text-gray-200 text-xs font-mono p-1 rounded w-60 h-24 outline-none resize-none block mt-2 mb-1 leading-tight';
            } else {
                input.type = 'text'; input.value = val;
                input.className = 'bg-transparent text-white text-center w-12 outline-none';
            }
            input.onmousedown = (e) => { e.stopPropagation(); selectWithoutRender(); };
            input.onchange = (e) => { 
                block.args[argIdx] = e.target.value; 
                checkAndAddInitBlocks(); 
                updateCode(); 
            };
            
            input.draggable = true;
            input.ondragstart = (e) => { e.preventDefault(); e.stopPropagation(); };
            
            slot.appendChild(input);
        } else {
            slot.innerText = '< >';
            slot.className += ' text-white/50 text-[10px]';
        }
        wrapper.appendChild(slot);
        return wrapper;
    }

    function setupDropZone(el, onDropSuccess, targetList) {
        el.ondragover = (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (dragData) {
                const type = dragData.defKey || findBlockType(dragData.id);
                if (!type || !BLOCK_DEFS[type]) return;
                const def = BLOCK_DEFS[type];
                
                let isValid = true;
                if (def.shape === SHAPES.HAT) isValid = false;
                if (def.shape === SHAPES.REPORTER || def.shape === SHAPES.BOOLEAN) isValid = false;

                if (targetList && targetList.length > 0) {
                    const lastBlock = targetList[targetList.length - 1];
                    const lastDef = BLOCK_DEFS[lastBlock.type];
                    if (lastDef && lastDef.shape === SHAPES.CAP) isValid = false;
                }

                if (isValid) el.classList.add('drop-target');
                else el.classList.add('drop-target-invalid'); 
            }
        };
        el.ondragleave = (e) => { e.preventDefault(); el.classList.remove('drop-target'); el.classList.remove('drop-target-invalid'); };
        el.ondrop = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const wasValid = el.classList.contains('drop-target');
            el.classList.remove('drop-target');
            el.classList.remove('drop-target-invalid');
            if (wasValid && dragData) handleDrop(dragData, null, null, 'APPEND', onDropSuccess);
        };
    }

    function handleDrop(data, targetContainer, targetIndex, mode = 'APPEND', customAction = null) {
        let block;
        if (data.type === 'NEW') {
            const def = BLOCK_DEFS[data.defKey];
            block = {
                id: uid(), type: data.defKey,
                args: def.args ? def.args.map(a => a.default) : [],
                children: [], elseChildren: [], ...data.data
            };
        } else {
            block = findAndRemoveBlock(data.id);
            if (!block) return;
        }

        if (!targetContainer && mode !== 'APPEND' && !customAction) targetContainer = state.script;

        if (mode === 'REPLACE') targetContainer[targetIndex] = block;
        else if (mode === 'INSERT') targetContainer.splice(targetIndex, 0, block);
        else if (mode === 'APPEND') {
            if (customAction) customAction(block);
            else if (targetContainer) targetContainer.push(block);
        }

        checkAndAddInitBlocks();
        renderWorkspace();
        updateCode();
    }

    function moveBlock(block, list) { list.push(block); }

    function findAndRemoveBlock(id, list = state.script) {
        const idx = list.findIndex(b => b.id === id);
        if (idx !== -1) {
            if (list[idx].locked) return null;
            return list.splice(idx, 1)[0];
        }
        for (let b of list) {
            if (b.children) { const res = findAndRemoveBlock(id, b.children); if (res) return res; }
            if (b.elseChildren) { const res = findAndRemoveBlock(id, b.elseChildren); if (res) return res; }
            if (b.args) {
                for (let i=0; i<b.args.length; i++) {
                    const arg = b.args[i];
                    if (typeof arg === 'object' && arg.id) {
                        if (arg.id === id) {
                             const def = BLOCK_DEFS[b.type];
                             b.args[i] = def.args[i].default;
                             return arg;
                        }
                        const res = findAndRemoveBlockInBlock(id, arg);
                        if (res) return res;
                    }
                }
            }
        }
        return null;
    }

    function findAndRemoveBlockInBlock(id, block) {
         if (block.children) { const res = findAndRemoveBlock(id, block.children); if (res) return res; }
         if (block.elseChildren) { const res = findAndRemoveBlock(id, block.elseChildren); if (res) return res; }
         if (block.args) {
            for (let i=0; i<block.args.length; i++) {
                const arg = block.args[i];
                if (typeof arg === 'object' && arg.id) {
                    if (arg.id === id) {
                        const def = BLOCK_DEFS[block.type];
                        block.args[i] = def.args[i].default;
                        return arg;
                    }
                    const res = findAndRemoveBlockInBlock(id, arg);
                    if (res) return res;
                }
            }
         }
         return null;
    }
    
    function findBlock(id, list = state.script) {
        for (let b of list) {
            if (b.id === id) return b;
            let found = (b.children && findBlock(id, b.children)) || (b.elseChildren && findBlock(id, b.elseChildren));
            if (found) return found;
            if (b.args) {
                for (let arg of b.args) {
                    if (typeof arg === 'object' && arg.id) {
                        if (arg.id === id) return arg;
                        found = findBlock(id, [arg]); 
                        if (found) return found;
                    }
                }
            }
        }
        return null;
    }

    function findBlockType(id, list = state.script) {
        for (let b of list) {
            if (b.id === id) return b.type;
            let found = (b.children && findBlockType(id, b.children)) || (b.elseChildren && findBlockType(id, b.elseChildren));
            if (found) return found;
            if (b.args) {
                for (let arg of b.args) {
                    if (typeof arg === 'object' && arg.id) {
                        if (arg.id === id) return arg.type;
                        found = findBlockType(id, [arg]);
                        if (found) return found;
                    }
                }
            }
        }
        return null;
    }

    function selectBlock(id) { selectedBlockIds.add(id); renderWorkspace(); }
    function toggleSelection(id) { if (selectedBlockIds.has(id)) selectedBlockIds.delete(id); else selectedBlockIds.add(id); renderWorkspace(); }
    function clearSelection() { selectedBlockIds.clear(); renderWorkspace(); hideContextMenu(); }
    function deleteSelected() { 
        selectedBlockIds.forEach(id => {
            const block = findBlock(id);
            if (block && !block.locked) findAndRemoveBlock(id);
        }); 
        selectedBlockIds.clear(); checkAndAddInitBlocks(); renderWorkspace(); updateCode(); hideContextMenu(); 
    }
    function duplicateSelected() { alert('Lite版: 請拖曳新積木'); hideContextMenu(); }
    
    function handleKeyDown(e) {
        if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
        if (e.key === 'Delete') deleteSelected();
    }

    function showContextMenu(e, id) {
        e.preventDefault();
        const block = findBlock(id);
        if (block && block.locked) return;
        if (!selectedBlockIds.has(id)) { clearSelectionDOM(); selectBlockDOM(id); }
        const menu = document.getElementById('context-menu');
        menu.style.display = 'block';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
    }
    function hideContextMenu() { document.getElementById('context-menu').style.display = 'none'; }

    // --- [V6.4] Auto Init Logic ---
    function checkAndAddInitBlocks() {
        let neededInits = [];
        let existingInits = new Set();

        const scanForNeeds = (arr) => {
            arr.forEach(b => {
                const args = b.args;
                // Output Pins
                if (['LED_SET', 'ADV_LED_BLINK', 'ANALOG_WRITE', 'ADV_RELAY_SET', 'ADV_RGB_SET', 'ADV_MOTOR_RUN'].includes(b.type)) {
                    if(b.type === 'ADV_RGB_SET') {
                         neededInits.push({type: 'PIN_MODE', args: [args[0], 'OUTPUT'], key: `pm_${args[0]}_out`});
                         neededInits.push({type: 'PIN_MODE', args: [args[1], 'OUTPUT'], key: `pm_${args[1]}_out`});
                         neededInits.push({type: 'PIN_MODE', args: [args[2], 'OUTPUT'], key: `pm_${args[2]}_out`});
                    } else {
                         neededInits.push({type: 'PIN_MODE', args: [args[0], 'OUTPUT'], key: `pm_${args[0]}_out`});
                    }
                }
                // Input Pins
                if (['DIGITAL_READ', 'ADV_BUTTON_PRESSED', 'ADV_IR_READ'].includes(b.type)) {
                     neededInits.push({type: 'PIN_MODE', args: [args[0], 'INPUT'], key: `pm_${args[0]}_in`});
                }
                // Special
                if (b.type === 'ADV_SERVO_WRITE') neededInits.push({type: 'ADV_SERVO_ATTACH', args: [args[0]], key: `servo_${args[0]}`});
                if (b.type === 'ADV_TM1637_SHOW') neededInits.push({type: 'ADV_TM1637_INIT', args: [args[0], args[1]], key: `tm_${args[0]}_${args[1]}`});
                if (b.type === 'SERIAL_PRINT') neededInits.push({type: 'SERIAL_BEGIN', args: [9600], key: `serial`});
                if (['ADV_LCD_PRINT', 'ADV_LCD_CLEAR'].includes(b.type)) neededInits.push({type: 'ADV_LCD_INIT', args: [], key: `lcd`});
                if (b.type === 'ADV_IR_READ') neededInits.push({type: 'ADV_IR_INIT', args: [args[0]], key: `ir_${args[0]}`});

                if (b.children) scanForNeeds(b.children);
                if (b.elseChildren) scanForNeeds(b.elseChildren);
                if (b.args) b.args.forEach(arg => { if (typeof arg === 'object' && arg.id) scanForNeeds([arg]); });
            });
        };
        
        const scanExisting = (arr) => {
            arr.forEach(b => {
                if (b.type === 'PIN_MODE') existingInits.add(`pm_${b.args[0]}_${b.args[1] === 'OUTPUT' ? 'out' : 'in'}`);
                if (b.type === 'ADV_SERVO_ATTACH') existingInits.add(`servo_${b.args[0]}`);
                if (b.type === 'ADV_TM1637_INIT') existingInits.add(`tm_${b.args[0]}_${b.args[1]}`);
                if (b.type === 'SERIAL_BEGIN') existingInits.add(`serial`);
                if (b.type === 'ADV_LCD_INIT') existingInits.add(`lcd`);
                if (b.type === 'ADV_IR_INIT') existingInits.add(`ir_${b.args[0]}`);
            });
        };

        scanForNeeds(state.script);
        scanExisting(state.script);

        let setupIdx = state.script.findIndex(b => b.type === 'SETUP');
        if (setupIdx === -1) return;

        // Insert after SETUP
        let insertIdx = setupIdx + 1;
        neededInits.forEach(req => {
            if (!existingInits.has(req.key)) {
                const newBlock = {
                    id: uid(), type: req.type, args: req.args, children: [], elseChildren: []
                };
                state.script.splice(insertIdx, 0, newBlock);
                insertIdx++; // Keep order
                existingInits.add(req.key);
            }
        });
    }

    function updateCode() {
        let includes = new Set();
        let globals = [];
        let setupCode = '';
        let loopCode = '';
        let functions = '';
        
        state.variables.forEach(v => { globals.push(`float ${v} = 0;`); });
        state.lists.forEach(l => { globals.push(`float ${l}[100];`); globals.push(`int ${l}_len = 0;`); });
        if (state.lists.length) functions += `void list_add(float* l, int* len, float v) { if(*len<100) l[(*len)++] = v; }\nvoid list_del_all(int* len) { *len=0; }\n`;

        // Pre-scan for libraries
        const scanGlobals = (arr) => {
            arr.forEach(b => {
                if (b.type === 'ADV_SERVO_ATTACH') {
                    includes.add('#include <Servo.h>');
                    if(!globals.some(g=>g.includes(`servo_${b.args[0]}`))) globals.push(`Servo servo_${b.args[0]};`);
                }
                if (b.type === 'ADV_LCD_INIT') {
                    includes.add('#include <Wire.h>');
                    includes.add('#include <LiquidCrystal_I2C.h>');
                    if(!globals.some(g=>g.includes('lcd'))) globals.push(`LiquidCrystal_I2C lcd(0x27, 16, 2);`);
                }
                if (b.type === 'ADV_TM1637_INIT') {
                     includes.add('#include <TM1637Display.h>');
                     if(!globals.some(g=>g.includes('display'))) globals.push(`TM1637Display display(${b.args[0]}, ${b.args[1]});`);
                }
                if (b.type === 'ADV_IR_INIT') {
                    includes.add('#include <IRremote.h>');
                    if(!globals.some(g=>g.includes('irrecv'))) globals.push(`IRrecv irrecv(${b.args[0]}); decode_results results;`);
                }
                if (b.children) scanGlobals(b.children);
                if (b.elseChildren) scanGlobals(b.elseChildren);
            });
        };
        scanGlobals(state.script);

        if (state.script.some(b=>JSON.stringify(b).includes('ADV_ULTRASONIC_READ'))) {
            functions += `float getUltrasonic(int t, int e) { pinMode(t, OUTPUT); digitalWrite(t,0); delayMicroseconds(2); digitalWrite(t,1); delayMicroseconds(10); digitalWrite(t,0); pinMode(e, INPUT); return pulseIn(e,1)*0.034/2; }\n`;
        }

        const parseBlock = (b) => {
            const args = (b.args || []).map(a => (typeof a === 'object' && a.id) ? parseBlock(a) : a);
            switch(b.type) {
                case 'SETUP': return ''; 
                case 'RAW_CODE': return `${args[0]}\n`;
                case 'SERIAL_BEGIN': return `Serial.begin(${args[0]});\n`; 
                case 'SERIAL_PRINT': return `Serial.println(${args[0]});\n`;
                case 'WAIT': return `delay(${args[0]});\n`;
                case 'WAIT_UNTIL': return `while(!(${args[0]})) { delay(10); }\n`;
                case 'FOREVER': return `// Loop\n${parseChildren(b.children)}`;
                case 'REPEAT': return `for(int i=0; i<${args[0]}; i++) {\n${parseChildren(b.children)}}\n`;
                case 'REPEAT_UNTIL': return `while(!(${args[0]})) {\n${parseChildren(b.children)}}\n`;
                case 'IF': return `if(${args[0]}) {\n${parseChildren(b.children)}}\n`;
                case 'IF_ELSE': return `if(${args[0]}) {\n${parseChildren(b.children)}} else {\n${parseChildren(b.elseChildren)}}\n`;
                case 'NUMBER': return `${args[0]}`;
                case 'COMPARE': return `(${args[0]} ${args[1]} ${args[2]})`;
                case 'VAR_GET': return `${b.varName || b.args[0]}`;
                case 'VAR_SET': return `${args[0]} = ${args[1]};\n`;
                case 'VAR_CHANGE': return `${args[0]} += ${args[1]};\n`;
                case 'PIN_MODE': return `pinMode(${args[0]}, ${args[1]});\n`;
                case 'LED_SET': return `digitalWrite(${args[0]}, ${args[1]==='亮'?'HIGH':'LOW'});\n`;
                case 'DIGITAL_READ': return `digitalRead(${args[0]})`;
                case 'ANALOG_WRITE': return `analogWrite(${args[0]}, ${args[1]});\n`;
                
                case 'ADV_ULTRASONIC_READ': return `getUltrasonic(${args[0]}, ${args[1]})`;
                case 'ADV_IR_INIT': return `irrecv.enableIRIn();\n`;
                case 'ADV_IR_READ': return `irrecv.decode(&results) ? results.value : 0`;
                case 'ADV_BUTTON_PRESSED': return `(digitalRead(${args[0]}) == HIGH)`;
                case 'ADV_POT_READ': return `analogRead(${args[0]})`;
                case 'ADV_PHOTO_READ': return `analogRead(${args[0]})`;
                case 'ADV_LED_BLINK': return `digitalWrite(${args[0]}, 1); delay(${args[1]}); digitalWrite(${args[0]}, 0); delay(${args[1]});\n`;
                case 'ADV_RGB_SET': return `analogWrite(${args[0]}, 255); analogWrite(${args[1]}, 0); analogWrite(${args[2]}, 0);\n`;
                case 'ADV_RELAY_SET': return `digitalWrite(${args[0]}, ${args[1]==='開'?'HIGH':'LOW'});\n`;
                case 'ADV_LCD_INIT': return `lcd.init(); lcd.backlight();\n`;
                case 'ADV_LCD_PRINT': return `lcd.print(${args[0]});\n`;
                case 'ADV_LCD_CLEAR': return `lcd.clear();\n`;
                case 'ADV_TM1637_INIT': return `display.setBrightness(0x0f);\n`;
                case 'ADV_TM1637_SHOW': return `display.showNumberDec(${args[2]});\n`;
                case 'ADV_MOTOR_RUN': return `analogWrite(${args[0]}, ${args[1]});\n`;
                case 'ADV_SERVO_ATTACH': return `servo_${args[0]}.attach(${args[0]});\n`;
                case 'ADV_SERVO_WRITE': return `servo_${args[0]}.write(${args[1]});\n`;

                default: return `// ${b.type}\n`;
            }
        };
        const parseChildren = (arr) => arr ? arr.map(b => parseBlock(b)).join('') : '';

        state.script.forEach(b => {
            if (b.type === 'FOREVER') loopCode += parseChildren(b.children);
            else if (b.type !== 'SETUP') setupCode += parseBlock(b);
        });

        const uniqueGlobals = [...new Set(globals)];
        const uniqueIncludes = [...new Set(includes)];

        const full = `${uniqueIncludes.join('\n')}\n${uniqueGlobals.join('\n')}\n${functions}\nvoid setup() {\n${setupCode}}\n\nvoid loop() {\n${loopCode}}`;
        document.getElementById('code-preview').innerText = full;
    }

    function parseAndImportCode() {
        const code = document.getElementById('code-input').value;
        const errDiv = document.getElementById('import-error');
        errDiv.classList.add('hidden'); errDiv.innerText = '';

        try {
            state.script = [];
            state.script.push({ id: uid(), type: 'SETUP', args: [], children: [], locked: true });

            const setupMatch = code.match(/void\s+setup\s*\(\s*\)\s*\{([\s\S]*?)\}/);
            const loopMatch = code.match(/void\s+loop\s*\(\s*\)\s*\{([\s\S]*?)\}/);

            const parseBody = (bodyText) => {
                const blocks = [];
                const lines = bodyText.split(';');
                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;
                    
                    const pm = line.match(/pinMode\s*\(\s*(\d+)\s*,\s*(OUTPUT|INPUT)\s*\)/);
                    if (pm) {
                         blocks.push({ id: uid(), type: 'PIN_MODE', args: [pm[1], pm[2]] });
                         return;
                    }
                    const sb = line.match(/Serial\.begin\s*\(\s*(\d+)\s*\)/);
                    if (sb) {
                         blocks.push({ id: uid(), type: 'SERIAL_BEGIN', args: [sb[1]] });
                         return;
                    }
                    const dw = line.match(/digitalWrite\s*\(\s*(\d+)\s*,\s*(HIGH|LOW)\s*\)/);
                    if (dw) {
                        blocks.push({ id: uid(), type: 'LED_SET', args: [dw[1], dw[2] === 'HIGH' ? '亮' : '滅'] });
                        return;
                    }
                    const aw = line.match(/analogWrite\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)/);
                    if (aw) {
                         blocks.push({ id: uid(), type: 'ANALOG_WRITE', args: [aw[1], aw[2]] });
                         return;
                    }
                    const dl = line.match(/delay\s*\(\s*(\d+)\s*\)/);
                    if (dl) {
                        blocks.push({ id: uid(), type: 'WAIT', args: [dl[1]] });
                        return;
                    }
                    blocks.push({ id: uid(), type: 'RAW_CODE', args: [line + ';'] });
                });
                return blocks;
            };

            if (setupMatch) {
                const setupBlocks = parseBody(setupMatch[1]);
                state.script.push(...setupBlocks);
            }
            if (loopMatch) {
                const loopBlocks = parseBody(loopMatch[1]);
                if (loopBlocks.length > 0) {
                    const foreverBlock = {
                        id: uid(), type: 'FOREVER', args: [], 
                        children: loopBlocks, elseChildren: []
                    };
                    state.script.push(foreverBlock);
                }
            }
            renderWorkspace();
            updateCode();
            switchMode('blocks');
            alert(`匯入成功！`);
        } catch (e) {
            errDiv.innerText = "解析錯誤: " + e.message;
            errDiv.classList.remove('hidden');
        }
    }

    let modalType = '';
    function openModal(type) {
        modalType = type;
        document.getElementById('modal-title').innerText = type==='VAR'?'新變數':'新清單';
        document.getElementById('modal-input').value = '';
        document.getElementById('modal-overlay').classList.remove('hidden');
    }
    function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
    document.getElementById('modal-confirm').onclick = () => {
        const name = document.getElementById('modal-input').value.trim();
        if (name) {
            if (modalType === 'VAR') state.variables.push(name);
            else state.lists.push(name);
            renderSidebar();
        }
        closeModal();
    };

    function copyCode() {
        navigator.clipboard.writeText(document.getElementById('code-preview').innerText);
        alert('已複製');
    }

    init();
</script>
</body>
</html>
